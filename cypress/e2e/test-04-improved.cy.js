/**
 * TEST 04 COMPLET: add-calendar (verificaci√≥ exhaustiva configuracions sistema)
 * 
 * Test que verifica TOTA la funcionalitat de creaci√≥ de calendaris amb verificaci√≥ expl√≠cita:
 * - Crear calendaris de cada tipus (FP, BTX, Altre) amb valors gen√®rics
 * - VERIFICAR EXPL√çCITAMENT que categories sistema coincideixen amb sys-categories.json
 * - VERIFICAR EXPL√çCITAMENT que esdeveniments sistema coincideixen amb config/*.json
 * - Verificar persist√®ncia i integritat de dades
 */

describe('IOC CALENDARI - TEST 04 COMPLET', () => {
  let configData = {};

  beforeEach(() => {
    cy.clearLocalStorage();
    cy.visit('/');
    cy.contains('Calendari IOC').should('be.visible');
    cy.wait(1000);
    
    // Carregar TOTS els fitxers de configuraci√≥ per verificaci√≥ exhaustiva
    cy.readFile('config/sys-categories.json').then(data => {
      configData.sysCategories = data;
    });
    cy.readFile('config/fp-semestre.json').then(data => {
      configData.fpSemestre = data;
    });
    cy.readFile('config/btx-semestre.json').then(data => {
      configData.btxSemestre = data;
    });
    cy.readFile('config/common-semestre.json').then(data => {
      configData.commonSemestre = data;
    });
  });

  it('04. add-calendar - VERIFICACI√ì EXHAUSTIVA CONFIGURACIONS SISTEMA', () => {
    // === FASE 1: CREAR CALENDARI FP ===
    cy.log('üìö FASE 1: Creant calendari FP...');
    
    cy.get('[data-action="new-calendar"]').click();
    cy.wait(300);
    
    cy.get('#studyType').select('Formaci√≥ Professional (FP)');
    cy.wait(200);
    
    // Usar valors gen√®rics (NO hardcoding DAW/M06)
    cy.get('#cicleCode').type('TCICLE');
    cy.get('#moduleCode').type('TMODUL');
    
    cy.get('[data-action="add-calendar"]').click();
    cy.wait(3000); // Esperar c√†rrega completa configuracions
    
    // Verificar calendari FP creat
    cy.get('.calendar-list-item')
      .should('contain.text', 'TCICLE')
      .should('contain.text', 'TMODUL');
    cy.log('‚úÖ Calendari FP creat correctament');
    
    // === VERIFICACI√ì EXHAUSTIVA CATEGORIES SISTEMA FP ===
    cy.log('üè∑Ô∏è VERIFICANT categories sistema vs sys-categories.json...');
    
    cy.window().then((win) => {
      const data = JSON.parse(win.localStorage.getItem('calendari-ioc-data'));
      const calendarsList = Object.values(data.calendars);
      const fpCalendar = calendarsList.find(cal => cal.type === 'FP');
      
      expect(fpCalendar).to.exist;
      const categories = fpCalendar.categories || [];
      
      // Verificar categories de sistema (longitud din√†mica del JSON)
      const sysCategories = categories.filter(cat => cat.isSystem === true);
      const expectedCategoryCount = configData.sysCategories.length;
      expect(sysCategories).to.have.length(expectedCategoryCount);
      cy.log(`üìä Categories sistema trobades: ${sysCategories.length}/${expectedCategoryCount}`);
      
      // VERIFICACI√ì EXPL√çCITA: cada categoria del JSON config/ ha d'existir al calendari
      configData.sysCategories.forEach((categoryFromConfig, index) => {
        const categoryInCalendar = sysCategories.find(calendarCat => 
          calendarCat.id === categoryFromConfig.id && 
          calendarCat.name === categoryFromConfig.name &&
          calendarCat.isSystem === true
        );
        
        expect(categoryInCalendar).to.exist;
        expect(categoryInCalendar.id).to.equal(categoryFromConfig.id);
        expect(categoryInCalendar.name).to.equal(categoryFromConfig.name);
        expect(categoryInCalendar.isSystem).to.be.true;
        
        cy.log(`‚úÖ Categoria ${index + 1} VERIFICADA:`);
        cy.log(`   Config: ${categoryFromConfig.id} ‚Üí ${categoryFromConfig.name}`);
        cy.log(`   Calendari: ${categoryInCalendar.id} ‚Üí ${categoryInCalendar.name}`);
      });
      
      cy.log('üéâ TOTES les categories sistema coincideixen amb sys-categories.json');
    });
    
    // === VERIFICACI√ì EXHAUSTIVA ESDEVENIMENTS SISTEMA FP ===
    cy.log('üìÖ VERIFICANT esdeveniments sistema FP vs config/*.json...');
    
    cy.window().then((win) => {
      const data = JSON.parse(win.localStorage.getItem('calendari-ioc-data'));
      const calendarsList = Object.values(data.calendars);
      const fpCalendar = calendarsList.find(cal => cal.type === 'FP');
      
      const events = fpCalendar.events || [];
      const sysEvents = events.filter(event => event.isSystemEvent === true);
      
      // Combinar esdeveniments esperats (FP + common)
      const expectedEvents = [
        ...configData.fpSemestre.systemEvents,
        ...configData.commonSemestre.systemEvents
      ];
      
      cy.log(`üìä Esdeveniments sistema: ${sysEvents.length}, Esperats: ${expectedEvents.length}`);
      
      // VERIFICACI√ì EXPL√çCITA: cada esdeveniment del JSON config/ ha d'existir al calendari
      expectedEvents.forEach((eventFromConfig, index) => {
        const eventInCalendar = sysEvents.find(calendarEvent => 
          calendarEvent.title === eventFromConfig.title && 
          calendarEvent.date === eventFromConfig.date &&
          calendarEvent.categoryId === eventFromConfig.categoryId &&
          calendarEvent.isSystemEvent === true
        );
        
        expect(eventInCalendar).to.exist;
        expect(eventInCalendar.title).to.equal(eventFromConfig.title);
        expect(eventInCalendar.date).to.equal(eventFromConfig.date);
        expect(eventInCalendar.categoryId).to.equal(eventFromConfig.categoryId);
        expect(eventInCalendar.isSystemEvent).to.be.true;
        
        if (index < 5) { // Log nom√©s els primers 5 per no saturar
          cy.log(`‚úÖ Event ${index + 1} VERIFICAT:`);
          cy.log(`   Config: "${eventFromConfig.title}" (${eventFromConfig.date})`);
          cy.log(`   Calendari: "${eventInCalendar.title}" (${eventInCalendar.date})`);
        }
      });
      
      cy.log(`üéâ TOTS els ${expectedEvents.length} esdeveniments sistema FP coincideixen amb config/`);
    });
    
    // === FASE 2: CREAR CALENDARI BTX ===
    cy.log('üéì FASE 2: Creant calendari BTX...');
    
    cy.get('[data-action="new-calendar"]').click();
    cy.wait(300);
    
    cy.get('#studyType').select('BTX');
    cy.wait(200);
    
    cy.get('#subjectCode').type('TSUBJECT');
    
    cy.get('[data-action="add-calendar"]').click();
    cy.wait(3000);
    
    // Verificar calendari BTX creat
    cy.get('.calendar-list-item')
      .should('contain.text', 'BTX')
      .should('contain.text', 'TSUBJECT');
    cy.log('‚úÖ Calendari BTX creat correctament');
    
    // === VERIFICACI√ì EXHAUSTIVA CATEGORIES SISTEMA BTX ===
    cy.log('üè∑Ô∏è VERIFICANT categories sistema BTX...');
    
    cy.window().then((win) => {
      const data = JSON.parse(win.localStorage.getItem('calendari-ioc-data'));
      const calendarsList = Object.values(data.calendars);
      const btxCalendar = calendarsList.find(cal => cal.type === 'BTX');
      
      expect(btxCalendar).to.exist;
      const categories = btxCalendar.categories || [];
      const sysCategories = categories.filter(cat => cat.isSystem === true);
      
      // BTX ha de tenir les mateixes categories sistema que FP (longitud din√†mica)
      const expectedCategoryCount = configData.sysCategories.length;
      expect(sysCategories).to.have.length(expectedCategoryCount);
      
      configData.sysCategories.forEach((categoryFromConfig) => {
        const categoryInCalendar = sysCategories.find(calendarCat => 
          calendarCat.id === categoryFromConfig.id && 
          calendarCat.name === categoryFromConfig.name &&
          calendarCat.isSystem === true
        );
        expect(categoryInCalendar).to.exist;
      });
      
      cy.log('‚úÖ Categories sistema BTX coincideixen amb sys-categories.json');
    });
    
    // === VERIFICACI√ì EXHAUSTIVA ESDEVENIMENTS SISTEMA BTX ===
    cy.log('üìÖ VERIFICANT esdeveniments sistema BTX vs config/*.json...');
    
    cy.window().then((win) => {
      const data = JSON.parse(win.localStorage.getItem('calendari-ioc-data'));
      const calendarsList = Object.values(data.calendars);
      const btxCalendar = calendarsList.find(cal => cal.type === 'BTX');
      
      const events = btxCalendar.events || [];
      const sysEvents = events.filter(event => event.isSystemEvent === true);
      
      // Combinar esdeveniments esperats (BTX + common)
      const expectedBtxEvents = [
        ...configData.btxSemestre.systemEvents,
        ...configData.commonSemestre.systemEvents
      ];
      
      cy.log(`üìä Esdeveniments sistema BTX: ${sysEvents.length}, Esperats: ${expectedBtxEvents.length}`);
      
      // VERIFICACI√ì EXPL√çCITA: cada esdeveniment BTX del JSON config/ ha d'existir al calendari
      expectedBtxEvents.forEach((eventFromConfig) => {
        const eventInCalendar = sysEvents.find(calendarEvent => 
          calendarEvent.title === eventFromConfig.title && 
          calendarEvent.date === eventFromConfig.date &&
          calendarEvent.categoryId === eventFromConfig.categoryId &&
          calendarEvent.isSystemEvent === true
        );
        
        expect(eventInCalendar).to.exist;
        expect(eventInCalendar.title).to.equal(eventFromConfig.title);
        expect(eventInCalendar.date).to.equal(eventFromConfig.date);
        expect(eventInCalendar.categoryId).to.equal(eventFromConfig.categoryId);
        expect(eventInCalendar.isSystemEvent).to.be.true;
      });
      
      cy.log(`üéâ TOTS els ${expectedBtxEvents.length} esdeveniments sistema BTX coincideixen amb config/`);
    });
    
    // === FASE 3: CREAR CALENDARI ALTRE ===
    cy.log('üìù FASE 3: Creant calendari Altre...');
    
    cy.get('[data-action="new-calendar"]').click();
    cy.wait(300);
    
    cy.get('#studyType').select('Altre');
    cy.wait(200);
    
    const currentYear = new Date().getFullYear();
    cy.get('#calendarName').type('Test Calendari Altre');
    cy.get('#startDate').type(`${currentYear + 1}-01-01`);
    cy.get('#endDate').type(`${currentYear + 1}-12-31`);
    
    cy.get('[data-action="add-calendar"]').click();
    cy.wait(1000);
    
    cy.get('.calendar-list-item').should('contain.text', 'Test Calendari Altre');
    cy.log('‚úÖ Calendari Altre creat correctament');
    
    // === VERIFICAR QUE CALENDARI ALTRE NO CARREGA CONFIGURACIONS SISTEMA ===
    cy.log('üîç VERIFICANT que calendari Altre NO carrega configuracions sistema...');
    
    cy.window().then((win) => {
      const data = JSON.parse(win.localStorage.getItem('calendari-ioc-data'));
      const calendarsList = Object.values(data.calendars);
      const altreCalendar = calendarsList.find(cal => cal.type === 'Altre');
      
      expect(altreCalendar).to.exist;
      
      // Verificar categories - NO ha de tenir categories de sistema
      const categories = altreCalendar.categories || [];
      const sysCategories = categories.filter(cat => cat.isSystem === true);
      expect(sysCategories).to.have.length(0);
      
      // Verificar esdeveniments - NO ha de tenir esdeveniments de sistema
      const events = altreCalendar.events || [];
      const sysEvents = events.filter(event => event.isSystemEvent === true);
      expect(sysEvents).to.have.length(0);
      
      cy.log('‚úÖ Calendari Altre NO carrega cap configuraci√≥ de sistema (correcte)');
    });
    
    // === FASE 4: VERIFICAR VISTES I NAVEGACI√ì DATES ===
    cy.log('üëÅÔ∏è FASE 4: Verificant vistes i navegaci√≥ de dates...');
    
    // Activar el primer calendari per provar les vistes
    cy.get('.calendar-list-item').first().then($item => {
      if ($item.find('[data-action="switch-calendar"]').length > 0) {
        cy.wrap($item).find('[data-action="switch-calendar"]').click();
        cy.wait(1000);
        cy.log('‚úÖ Calendari activat per provar vistes');
      }
    });
    
    // === VERIFICAR VISTES DISPONIBLES ===
    cy.log('üìã Verificant que totes les vistes funcionen...');
    
    // Provar vista mensual
    cy.get('body').then($body => {
      if ($body.find('[data-action="change-view"][data-view="month"], [data-view="month"]').length > 0) {
        cy.get('[data-action="change-view"][data-view="month"], [data-view="month"]').first().click();
        cy.wait(500);
        cy.log('‚úÖ Vista mensual activada');
      } else {
        cy.log('‚ÑπÔ∏è Bot√≥ vista mensual no trobat');
      }
    });
    
    // Provar vista setmanal si existeix
    cy.get('body').then($body => {
      if ($body.find('[data-action="change-view"][data-view="week"], [data-view="week"]').length > 0) {
        cy.get('[data-action="change-view"][data-view="week"], [data-view="week"]').first().click();
        cy.wait(500);
        cy.log('‚úÖ Vista setmanal activada');
        
        // Tornar a vista mensual per continuar tests
        cy.get('[data-action="change-view"][data-view="month"], [data-view="month"]').first().click();
        cy.wait(500);
      } else {
        cy.log('‚ÑπÔ∏è Vista setmanal no disponible');
      }
    });
    
    // === VERIFICAR NAVEGACI√ì DE DATES ===
    cy.log('üìÖ Verificant navegaci√≥ limitada al rang del calendari...');
    
    cy.window().then((win) => {
      const data = JSON.parse(win.localStorage.getItem('calendari-ioc-data'));
      const calendarsList = Object.values(data.calendars);
      const activeCalendar = calendarsList[0]; // Primer calendari
      
      cy.log(`üìä Calendari actiu: ${activeCalendar.name}`);
      cy.log(`üìÖ Rang v√†lid: ${activeCalendar.startDate} ‚Üí ${activeCalendar.endDate}`);
      
      // Verificar que hi ha calendari visual carregat
      cy.get('body').then($body => {
        if ($body.find('.calendar-container, .calendar-grid, .month-view').length > 0) {
          cy.log('‚úÖ Calendari visual detectat');
          
          // Verificar que hi ha dies visibles
          cy.get('.day-cell, .calendar-day, .day, [data-date]').then($days => {
            if ($days.length > 0) {
              cy.log(`üìä Dies visibles al calendari: ${$days.length}`);
              
              // Provar click en un dia (ha de ser dins del rang)
              const firstDay = $days.first();
              const dayDate = firstDay.attr('data-date') || firstDay.text();
              
              cy.wrap(firstDay).click({ force: true });
              cy.wait(300);
              cy.log(`‚úÖ Click en dia funcionant: ${dayDate}`);
              
            } else {
              cy.log('‚ÑπÔ∏è No s\'han detectat dies clicables al calendari');
            }
          });
          
          // Verificar botons de navegaci√≥
          cy.get('body').then($navBody => {
            const prevBtn = $navBody.find('.nav-arrow[data-direction="-1"], .prev-month, .nav-prev');
            const nextBtn = $navBody.find('.nav-arrow[data-direction="1"], .next-month, .nav-next');
            
            if (prevBtn.length > 0) {
              cy.log('üìç Bot√≥ navegaci√≥ anterior trobat');
              // Verificar si est√† deshabitat quan estem al l√≠mit
              if (prevBtn.is(':disabled')) {
                cy.log('‚úÖ Bot√≥ anterior deshabitat (correcte - al l√≠mit del calendari)');
              } else {
                cy.log('‚ÑπÔ∏è Bot√≥ anterior habilitat');
              }
            }
            
            if (nextBtn.length > 0) {
              cy.log('üìç Bot√≥ navegaci√≥ seg√ºent trobat');
              if (nextBtn.is(':disabled')) {
                cy.log('‚úÖ Bot√≥ seg√ºent deshabitat (correcte - al l√≠mit del calendari)');
              } else {
                cy.log('‚ÑπÔ∏è Bot√≥ seg√ºent habilitat');
              }
            }
          });
          
        } else {
          cy.log('‚ö†Ô∏è Calendari visual no detectat - saltant verificaci√≥ navegaci√≥');
        }
      });
    });
    
    // === FASE 5: VERIFICACI√ì FINAL INTEGRITAT ===
    cy.log('üîß FASE 5: Verificant integritat final...');
    
    cy.window().then((win) => {
      const data = JSON.parse(win.localStorage.getItem('calendari-ioc-data'));
      const calendarsList = Object.values(data.calendars);
      
      // Verificar estructura completa
      expect(calendarsList).to.have.length(3);
      
      // Verificar cada calendari t√© les propietats necess√†ries
      calendarsList.forEach((calendar) => {
        expect(calendar).to.have.property('id');
        expect(calendar).to.have.property('name');
        expect(calendar).to.have.property('type');
        expect(calendar).to.have.property('categories');
        expect(calendar).to.have.property('events');
      });
      
      cy.log('‚úÖ Estructura localStorage completa i v√†lida');
    });
    
    // Verificar aplicaci√≥ funcional
    cy.get('[data-action="new-calendar"]')
      .should('exist')
      .should('be.visible')
      .should('not.be.disabled');
    
    cy.log('üéâ ADD-CALENDAR: VERIFICACI√ì EXHAUSTIVA CONFIGURACIONS SISTEMA PERFECTA!');
    cy.log('üìä RESUM: 3 calendaris creats, categories i esdeveniments verificats contra config/');
  });

});